
<!DOCTYPE html>
<html lang="fr">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <title>Initiation à rpart</title>
  
  <meta name="description" content="Apiacoa.org : Initiation à rpart">
  <meta name="author" content="Fabrice Rossi">
  <link rel="alternate" type="application/atom+xml" title="Fabrice Rossi (Apiacoa.org)" href="http://apiacoa.org/feed.xml"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="http://apiacoa.org/assets/apiacoa/css/apiacoa.css" rel="stylesheet" type="text/css">
<link href="http://apiacoa.org/assets/twitter/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="http://apiacoa.org/assets/twitter/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css">
<link href="http://apiacoa.org/assets/apiacoa/css/publications.css" rel="stylesheet" type="text/css">
<link href="http://apiacoa.org/assets/apiacoa/css/pygment.css" rel="stylesheet" type="text/css">

</head>

  <body>
    <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
	<span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span> 
      </a>
      <a class="brand" href="http://apiacoa.org/">Apiacoa.org</a>
      <div class="nav-collapse">
        <ul class="nav">
	  <li><a href="http://apiacoa.org/index.fr.html">Accueil</a></li>
	  <li  class="active" ><a href="http://apiacoa.org/blog/index.fr.html">Blog</a></li>
	  <li><a href="http://apiacoa.org/research/index.fr.html">Recherche</a></li>
	  <li><a href="http://apiacoa.org/teaching/index.fr.html">Enseignement</a></li>
        </ul>
	
      </div>
    </div>
  </div>
</div>


    <div class="container-fluid">    
      <div class="row-fluid">
	<div class="span1 hidden-phone"></div>
        <div class="span10">
	  <div class="page-header">
            <h1>Initiation à rpart</h1>
	  </div>
	  <ul class="pager">
   
  <li class="previous">
    <a rel="prev" href="/blog/2014/01/h%C3%A9ritage-poo-.fr.html">&larr; Précédent</a>
    
  </li>
   
  <li class="next">
    <a rel="next" href="/blog/2014/09/enonces-de-poo.fr.html">Suivant &rarr;</a>
    
  </li>
</ul>

	</div>
	<div class="span1 hidden-phone"></div>
      </div>
      <div class="row-fluid">
	<div class="span1 hidden-phone"></div>
        <div class="span8">
          <p>
Le package <a href="http://www.r-project.org/">R</a> <a href="http://cran.r-project.org/web/packages/rpart/index.html">rpart</a> propose une implémentation des méthodes de construction
d'<a href="https://fr.wikipedia.org/wiki/Arbre_de_d%C3%A9cision">arbres de décision</a> inspirées de l'approche CART décrite dans l'ouvrage
éponyme de Breiman, Friedman, Olshen et Stone en 1983. Ce billet propose une
prise en main élémentaire de rpart en complément dans la documentation et des
vignettes disponibles. 
</p>


<h2 id="orgheadline3">Construction de l'arbre</h2>
<div class="outline-text-2" id="text-orgheadline3">
</div>
<h3 id="orgheadline1">Préparation des données</h3>
<p>
On travaille ici sur les données Titanic disponible dans le package
<a href="http://cran.r-project.org/web/packages/rpart.plot/index.html">rpart.plot</a>. On charge les deux packages puis les données comme ceci :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>rpart<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>rpart.plot<span class="p">)</span>
data<span class="p">(</span>ptitanic<span class="p">)</span></code></pre></div>

<p>
Les données décrivent 1046 passagers selon 6 variables :
</p>
<ul class="org-ul">
<li><code>pclass</code> donne la classe tarifaire sur le bateau ;</li>
<li><code>survided</code> indique si le passager a survécu ;</li>
<li><code>sex</code> donne le genre du passager ;</li>
<li><code>age</code> donne l'âge du passager exprimé en années ;</li>
<li><code>sibsp</code> donne le nombre de frères, sœurs, mari ou épouse à bord ;</li>
<li><code>parch</code> donne le nombre d'enfants ou de parents à bord.</li>
</ul>
<p>
Les trois dernières variables sont numériques alors que les trois premières
sont nominales. Il faut bien s'assurer que la représentation en R des
variables respecte leur nature. Pour ce faire, on utilise :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">lapply</span><span class="p">(</span>ptitanic<span class="p">,</span><span class="kp">class</span><span class="p">)</span></code></pre></div>
<p>
qui donne la classe de chaque variable, soit ici:
</p>
<pre class="example">
$pclass
[1] "factor"

$survived
[1] "factor"

$sex
[1] "factor"

$age
[1] "labelled"

$sibsp
[1] "labelled"

$parch
[1] "labelled"
</pre>

<p>
Les trois variables nominales sont donc bien des <code>factor</code>. Pour les valeurs
numériques, on obtient la classe <code>labelled</code> qui est spécifique au package
<a href="http://cran.r-project.org/web/packages/Hmisc/index.html">Hmisc</a>. On peut vérifier en supprimant cette classe que les variables
correspondantes sont bien numériques, comme dans le code suivant :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">attr</span><span class="p">(</span>ptitanic<span class="o">$</span>age<span class="p">,</span><span class="s">&quot;class&quot;</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="kp">class</span><span class="p">(</span>ptitanic<span class="o">$</span>age<span class="p">)</span></code></pre></div>
<p>
qui affiche bien
</p>
<pre class="example">
[1] "numeric"
</pre>
<p>
comme attendu.
</p>


<h3 id="orgheadline2">Construction de l'arbre complet</h3>
<p>
La fonction de construction d'un arbre s'appelle <code>rpart</code>, comme le package. On
l'utilise en général avec l'interface des <a href="http://cran.r-project.org/doc/manuals/r-release/R-intro.html#Formulae-for-statistical-models">formules</a> de R, comme ci-dessous :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">ptitanicTree <span class="o">&lt;-</span> rpart<span class="p">(</span>survived<span class="o">~</span><span class="m">.</span><span class="p">,</span>data<span class="o">=</span>ptitanic<span class="p">)</span></code></pre></div>

<p>
La formule utilisée <code>survived~.</code> indique qu'on souhaite prédire la variable
<code>survived</code> en fonction de toutes les autres. Le principe général est que la (ou
les) variable(s) à prédire sont à gauche du symbole <code>~</code> alors que les
variables prédictives sont à droite du symbole. Ici, le point <code>.</code> permet
d'indiquer qu'on souhaite utiliser toutes les variables des données comme
prédicteurs sauf les variables à prédire (ce qui évite d'avoir à écrire la
liste des prédicteurs). 
</p>

<p>
On a utilisé ici les paramètres par défaut de la fonction <code>rpart</code>, ce qui ne
conduit pas toujours à la solution désirée. En effet, <code>rpart</code> ne construit en
général pas l'arbre le plus complet possible, pour des raisons
d'efficacité. Il est rare en pratique qu'un arbre très profond qui ne réalise
aucune erreur de classement sur les données d'apprentissage soit le plus
adapté. Il sur-apprend massivement, en général. Il n'est donc pas très utile
de construire un tel arbre, puisqu'on devra en pratique l'élaguer. 
</p>

<p>
Cependant, il arrive sur des données de petite taille que les paramètres par
défaut de <code>rpart</code> soient trop conservateurs. Par exemple, <code>rpart</code> ne découpe
pas une feuille contenant 20 observations. De même <code>rpart</code> demande une
amélioration relative d'au moins 1 % de la qualité d'une partition pour
effectuer un découpage. Pour changer ces valeurs, il suffit d'utiliser la
commande <code>rpart.control</code> en précisant les éléments à modifier. Le code
suivant 
</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">ptitanicTree <span class="o">&lt;-</span> rpart<span class="p">(</span>survived<span class="o">~</span><span class="m">.</span><span class="p">,</span>data<span class="o">=</span>ptitanic<span class="p">,</span>control<span class="o">=</span>rpart.control<span class="p">(</span>minsplit<span class="o">=</span><span class="m">5</span><span class="p">,</span>cp<span class="o">=</span><span class="m">0</span><span class="p">))</span></code></pre></div>
<p>
construit un arbre en continuant les découpages dans les feuilles qui
contiennent au moins 5 observations (paramètre <code>minsplit</code>) et sans contrainte
sur la qualité du découpage (paramètre <code>cp</code> mis à 0). L'arbre construit de
cette façon est assez volumineux et contient 65 feuilles. 
</p>


<h2 id="orgheadline7">Simplification de l'arbre</h2>
<div class="outline-text-2" id="text-orgheadline7">
</div>
<h3 id="orgheadline4">Niveaux de simplification</h3>
<p>
Pour choisir le bon niveau de simplification, ou encore le bon nombre de
feuilles, on procède par validation croisée. La fonction <code>rpart</code> réalise par
défaut une estimation des performances de l'arbre par validation croisée à 10
blocs pour chaque niveau de simplification pertinent. Le nombre de blocs se
règle au moment de la construction de l'arbre grâce au paramètre <code>xval</code> de
<code>rpart.control</code>. 
</p>

<p>
On peut afficher les résultats de cette opération grâce à la fonction
<code>printcp</code>, comme ci-dessous. La courbe indique le taux de mauvaises
classifications relativement au score d'origine (dans un arbre réduit à une
seule feuille dans laquelle la décision correspond à la classe majoritaire),
estimé par la validation croisée. Les barres d'erreur autour de chaque
estimation sont aussi obtenues par validation croisée. Ici, comme on a 809
morts et 500 survivants, l'erreur de référence est d'environ 38,2 %. L'axe des
abscisses indique la complexité de l'arbre par l'intermédiaire du nombre de feuilles.
</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">plotcp<span class="p">(</span>ptitanicTree<span class="p">)</span></code></pre></div>

<ul class="thumbnails">
<li class="span12">
<a class="thumbnail" href="http://apiacoa.org/teaching/machine-learning/titanicCp.svg"><img src="http://apiacoa.org/teaching/machine-learning/titanicCp.svg"
alt="Performances par validation croisée"></a>
<p>
<small>Performances par validation croisée</small>
</p>
</li>
</ul>


<h3 id="orgheadline5">Simplification</h3>
<p>
Comme attendu, les performances s'améliorent dans un premier temps quand on
augmente le nombre de feuilles puis se dégradent en raison du
sur-apprentissage. On choisit en général la complexité qui minimise l'erreur
estimée, soit ici 11 feuilles. Pour obtenir l'arbre simplifié, on utilise la
fonction <code>prune</code>, comme dans le code suivant :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">ptitanicSimple <span class="o">&lt;-</span> prune<span class="p">(</span>ptitanicTree<span class="p">,</span>cp<span class="o">=</span><span class="m">0.0047</span><span class="p">)</span></code></pre></div>

<p>
On utilise ici le <code>cp</code> affiché sur la courbe, ce qui n'est pas très
pratique. Pour automatiser le processus, on peut s'appuyer sur l'attribut
<code>cptable</code> des objets arbres. Cette matrice contient toutes les
informations utilisées pour produire le graphique ci-dessus. En pratique, on
peut retrouver l'arbre optimal en faisant :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">ptitanicOptimal <span class="o">&lt;-</span> prune<span class="p">(</span>ptitanicTree<span class="p">,</span>cp<span class="o">=</span>ptitanicTree<span class="o">$</span>cptable<span class="p">[</span><span class="kp">which.min</span><span class="p">(</span>ptitanicTree<span class="o">$</span>cptable<span class="p">[,</span><span class="m">4</span><span class="p">]),</span><span class="m">1</span><span class="p">])</span></code></pre></div>

<p>
Notons que la valeur de <code>cp</code> obtenue de cette façon n'est pas la même que
celle affichée sur la figure : les valeurs contenues dans la matrice <code>cptable</code>
sont celles qui produisent des changements dans le nombre de feuilles de
l'arbre. Pour des raisons de stabilité, on préfère parfois utiliser les
moyennes géométriques de deux nombres qui se suivent, ce qui explique la
valeur de <code>0.0047</code> sur le graphique contre <code>0.0028</code> par la table. Dans notre
contexte, ceci n'est pas très important.
</p>


<h3 id="orgheadline6">Représentation graphique</h3>
<p>
Le package <code>rpart</code> propose des fonctions d'affichage relativement limitées. On
préfère donc s'appuyer sur <code>rpart.plot</code>, en particulier sur sa fonction
<code>prp</code>. La figure ci-dessous est obtenue par le simple appel suivant :
</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">prp<span class="p">(</span>ptitanicOptimal<span class="p">,</span>extra<span class="o">=</span><span class="m">1</span><span class="p">)</span></code></pre></div>


<ul class="thumbnails">
<li class="span12">
<a class="thumbnail" href="http://apiacoa.org/teaching/machine-learning/titanicTree.svg"><img src="http://apiacoa.org/teaching/machine-learning/titanicTree.svg"
alt="Arbre simplifié"></a>
<p>
<small>Arbre simplifié : chaque nœud représente une question, la réponse non
étant toujours dans la branche droite de l'arbre. Chaque feuille est étiquetée
par la décision associée (ici died ou survived) et par l'effectif classe par
classe des individus affectés à la feuille. Par exemple, la feuille la plus à
gauche classe les individus en died, avec 660 individus de cette classe et 136
de la classe survived.</small>
</p>
</li>
</ul>


<h2 id="orgheadline10">Utilisation de l'arbre</h2>
<div class="outline-text-2" id="text-orgheadline10">
</div>
<h3 id="orgheadline8">Prévision</h3>
<p>
Comme tout modèle R, un arbre obtenu par <code>rpart</code> (avec ou sans simplification)
peut réaliser des prévisions sur de nouvelles données, en s'appuyant sur la
fonction <code>predict</code>. Par défaut, la fonction estime les probabilités
d'appartenance aux classes pour chaque observation (simplement par le ratio
dans la feuille correspondante). Par exemple le code suivant
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">predict<span class="p">(</span>ptitanicOptimal<span class="p">,</span>ptitanic<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,])</span></code></pre></div>
<p>
donne les estimations suivantes sur les dix premiers passagers :
</p>
<pre class="example">
        died  survived
1  0.0680000 0.9320000
2  0.1111111 0.8888889
3  0.0680000 0.9320000
4  0.8291457 0.1708543
5  0.0680000 0.9320000
6  0.8291457 0.1708543
7  0.0680000 0.9320000
8  0.8291457 0.1708543
9  0.0680000 0.9320000
10 0.8291457 0.1708543
</pre>
<p>
Pour obtenir la classe prédite, il suffit d'ajouter le paramètre <code>type</code> avec
la bonne valeur, soit :
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r">predict<span class="p">(</span>ptitanicOptimal<span class="p">,</span> ptitanic<span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,],</span> type<span class="o">=</span><span class="s">&quot;class&quot;</span><span class="p">)</span></code></pre></div>
<p>
ce qui donne :
</p>
<pre class="example">
       1        2        3        4        5        6        7        8 
survived survived survived     died survived     died survived     died 
       9       10 
survived     died 
Levels: died survived
</pre>


<h3 id="orgheadline9">Évaluation des performances</h3>
<p>
Pour évaluer correctement les performances de l'arbre simplifié, il faut
utiliser une procédure de type validation croisée en plus de celle qui est
intégrée dans <code>rpart</code> pour choisir la complexité de l'arbre. Le package <a href="http://caret.r-forge.r-project.org/">caret</a>
facilite cette opération en proposant des fonctions de découpage des données
bien conçues. 
</p>

<p>
Dans cette prise en main, nous nous contentons d'évaluer les performances sur
les données d'apprentissage ce qui sur-estime la qualité du modèle. Il s'agit
simplement d'une illustration ! Le principe est de s'appuyer sur la fonction
<code>predict</code> et sur la fonction <code>table</code> pour obtenir une matrice de
confusion. L'appel suivant 
</p>
<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kp">table</span><span class="p">(</span>ptitanic<span class="o">$</span>survived<span class="p">,</span> predict<span class="p">(</span>ptitanicOptimal<span class="p">,</span> ptitanic<span class="p">,</span> type<span class="o">=</span><span class="s">&quot;class&quot;</span><span class="p">))</span></code></pre></div>
<p>
produit ainsi la matrice de confusion suivante :
</p>
<pre class="example">
         died survived
died      752       57
survived  173      327
</pre>

<p>
On constate que la qualité de la prédiction dépend beaucoup de la classe. En
effet, sur les 809 passagers décédés, le taux de prévisions correctes est de
93 % environ, alors que sur les 500 survivants, il n'est que de 65 % environ.
</p>

	</div>
	<div class="span2">
	  <p><strong>Date de publication</strong></p>
	  <p> 6 février 2014</p>
	  <p><strong>Mots clés</strong></p>
	  
	  <p><a class="tag-link" href="http://apiacoa.org/blog/tag/enseignement.fr.html">enseignement</a></p>
	  
	  <p><a class="tag-link" href="http://apiacoa.org/blog/tag/R.fr.html">R</a></p>
	  
	  <p><a class="tag-link" href="http://apiacoa.org/blog/tag/rpart.fr.html">rpart</a></p>
	  
	  <p><a class="tag-link" href="http://apiacoa.org/blog/tag/rpart.plot.fr.html">rpart.plot</a></p>
	  
	</div>
	<div class="span1 hidden-phone"></div>
      </div>
    </div>
    <footer class="footer">
  <div class="container-fluid">
    <p class="pull-right"><a href="https://fr.wikipedia.org/wiki/Licorne_rose_invisible"><img src="http://apiacoa.org/assets/apiacoa/img/small_Invisible_pink_unicorn.png" alt="Logo de la licorne rose invisible"><a></p>
    <p><small>© <a href="http://apiacoa.org/contact.fr.html">Fabrice Rossi</a> 2003-2019</small></p>
    <p><small>Dernière mise à jour : 29 janvier 2021</small></p>
    <p><small><a href="http://apiacoa.org/thanks.fr.html">Remerciements</a></small></p>
  </div>      
</footer>

    <script src="http://apiacoa.org/assets/jquery/jquery-1.8.0.min.js"></script> 
<script src="http://apiacoa.org/assets/twitter/js/bootstrap.min.js"></script>


  </body>
</html>
